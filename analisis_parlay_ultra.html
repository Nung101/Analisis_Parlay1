<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analisis Parlay Ultra</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 15px; }
    h2 { margin-top: 20px; }
    .input-group { margin-bottom: 10px; }
    label { display: block; font-weight: bold; margin-bottom: 4px; }
    input, select { width: 100%; padding: 6px; margin-bottom: 8px; }
    button { padding: 10px 20px; font-weight: bold; margin-top: 10px; }
    #output { border: 1px solid #ccc; padding: 15px; margin-top: 20px; background: #f9f9f9; }
    .injury-list { margin: 5px 0; font-size: 14px; }
    .tooltip { font-size: 13px; color: #555; margin-top: -5px; margin-bottom: 8px; }
    .conf-low { color: red; font-weight: bold; }
    .conf-med { color: orange; font-weight: bold; }
    .conf-high { color: green; font-weight: bold; }
    .warning { color: red; font-weight: bold; margin-top: 10px; }
    .trap { color: darkred; font-weight: bold; margin-top: 8px; background: #ffe0e0; padding: 6px; border-radius: 5px; }
    .sim-table { border-collapse: collapse; margin-top: 10px; }
    .sim-table th, .sim-table td { border: 1px solid #ccc; padding: 4px 6px; font-size: 13px; }
  </style>
</head>
<body>
  <h2>Analisis Parlay ‚Äî Ultra (ExpG + ADI + H2H + Injury + Market Trap)</h2>  <div class="input-group">
    <label>Tim Home</label>
    <input type="text" id="team_home" placeholder="Contoh: Djurgarden">
    <label>Tim Away</label>
    <input type="text" id="team_away" placeholder="Contoh: IK Sirius">
  </div>  <div class="input-group">
    <label>Rata2 Gol Home (GF/90)</label>
    <input type="number" step="0.01" id="gf_home">
    <label>Rata2 Kebobolan Home (GA/90)</label>
    <input type="number" step="0.01" id="ga_home">
    <label>Rata2 Gol Away (GF/90)</label>
    <input type="number" step="0.01" id="gf_away">
    <label>Rata2 Kebobolan Away (GA/90)</label>
    <input type="number" step="0.01" id="ga_away">
  </div>  <div class="input-group">
    <label>H2H Home GF (avg per match) ‚Äî kosong kalau tidak ada</label>
    <input type="number" step="0.01" id="h2h_home">
    <label>H2H Away GF (avg per match) ‚Äî kosong kalau tidak ada</label>
    <input type="number" step="0.01" id="h2h_away">
  </div>  <div class="input-group">
    <label>Form Home GF (avg 5 matches) ‚Äî opsional</label>
    <input type="number" step="0.01" id="form_home">
    <label>Form Away GF (avg 5 matches) ‚Äî opsional</label>
    <input type="number" step="0.01" id="form_away">
  </div>  <div class="input-group">
    <label>Line O/U (contoh: 2.5 atau 3.0)</label>
    <input type="number" step="0.1" id="line_ou">
    <label>Odds Over (decimal)</label>
    <input type="number" step="0.01" id="odds_over">
    <label>Odds Under (decimal)</label>
    <input type="number" step="0.01" id="odds_under">
    <label>Competition (league / cup / ucl / uefa)</label>
    <input type="text" id="competition">
  </div>  <div class="input-group">
    <label>Mode Squad Depth</label>
    <select id="squad_mode">
      <option value="auto">Auto (default, hitung otomatis)</option>
      <option value="manual">Manual (isi sendiri)</option>
    </select>
    <div id="manual_squad_inputs" style="display:none;">
      <label>Squad Depth Home (0.6 - 1.8)</label>
      <input type="number" step="0.1" id="squad_home_manual">
      <div class="tooltip">0.6‚Äì0.9 = tim lemah / kedalaman tipis ‚Ä¢ 1.0‚Äì1.2 = tim normal ‚Ä¢ 1.3‚Äì1.8 = tim besar / banyak rotasi</div>
      <label>Squad Depth Away (0.6 - 1.8)</label>
      <input type="number" step="0.1" id="squad_away_manual">
      <div class="tooltip">Gunakan range yang sama. Jika ragu, biarkan Auto.</div>
    </div>
  </div>  <div class="input-group">
    <label>Injury Manager (pilih role lalu Add injury)</label>
    <div>
      <select id="role_home">
        <option value="rotation">Rotation / Pelapis</option>
        <option value="starter">Starter Reguler</option>
        <option value="key">Key Player</option>
        <option value="goalkeeper">Goalkeeper</option>
        <option value="def_core">Def Core</option>
        <option value="mid_core">Mid Core</option>
        <option value="striker_core">Striker Core</option>
      </select>
      <button onclick="addInjury('home')">Add Injury Home</button>
      <div id="injuries_home" class="injury-list"></div>
    </div>
    <div>
      <select id="role_away">
        <option value="rotation">Rotation / Pelapis</option>
        <option value="starter">Starter Reguler</option>
        <option value="key">Key Player</option>
        <option value="goalkeeper">Goalkeeper</option>
        <option value="def_core">Def Core</option>
        <option value="mid_core">Mid Core</option>
        <option value="striker_core">Striker Core</option>
      </select>
      <button onclick="addInjury('away')">Add Injury Away</button>
      <div id="injuries_away" class="injury-list"></div>
    </div>
    <div class="tooltip">Tip: gunakan role sesuai posisi & pentingnya pemain. Cedera GK & striker inti berdampak besar.</div>
  </div><button onclick="analisis()">Analisis Sekarang</button>

  <div id="output"></div><script>
let injuries = { home: [], away: [] };

const ROLE_IMPACT_V4 = {
  rotation: {OV:0.02, DV:0.02},
  starter: {OV:0.12, DV:0.10},
  key: {OV:0.25, DV:0.20},
  goalkeeper: {OV:0.00, DV:0.35},
  def_core: {OV:0.03, DV:0.22},
  mid_core: {OV:0.10, DV:0.10},
  striker_core: {OV:0.22, DV:0.05}
};

function addInjury(side) {
  const role = document.getElementById(`role_${side}`).value;
  injuries[side].push({ role });
  renderInjuries();
}

function renderInjuries() {
  document.getElementById('injuries_home').innerHTML = injuries.home.map(i=>`‚Ä¢ ${i.role}`).join('<br>');
  document.getElementById('injuries_away').innerHTML = injuries.away.map(i=>`‚Ä¢ ${i.role}`).join('<br>');
}

function autoSquadDepth(gf, ga) {
  let sdi = 1.0 + ((gf - ga) / 4);
  return Math.max(0.6, Math.min(1.8, sdi));
}

function applyInjuryV4(expHome, expAway, compFactor=1.0, oppFactor=1.0, locFactor=1.0) {
  let hOV=0, hDV=0, aOV=0, aDV=0;
  injuries.home.forEach(it=>{ let r=ROLE_IMPACT_V4[it.role]||{OV:0.05,DV:0.05}; hOV+=r.OV; hDV+=r.DV; });
  injuries.away.forEach(it=>{ let r=ROLE_IMPACT_V4[it.role]||{OV:0.05,DV:0.05}; aOV+=r.OV; aDV+=r.DV; });

  let factor = compFactor*oppFactor*locFactor;
  expHome = expHome*(1-hOV*factor)+aDV*factor;
  expAway = expAway*(1-aOV*factor)+hDV*factor;

  return {expHome,expAway};
}

const squadMode = document.getElementById('squad_mode');
squadMode.addEventListener('change', ()=>{
  document.getElementById('manual_squad_inputs').style.display = (squadMode.value==='manual') ? 'block' : 'none';
});

function getConfidenceClass(conf){
  if(conf>=60) return 'conf-high';
  if(conf>=30) return 'conf-med';
  if(conf>0) return 'conf-low';
  return '';
}

function simulateScores(lambdaHome, lambdaAway, n=5000){
  let results = {};
  function poissonSample(lambda){
    let L=Math.exp(-lambda), k=0, p=1;
    do {k++; p*=Math.random();} while(p>L);
    return k-1;
  }
  for(let i=0;i<n;i++){
    let h=poissonSample(lambdaHome);
    let a=poissonSample(lambdaAway);
    let key=h+"-"+a;
    results[key]=(results[key]||0)+1;
  }
  let arr=Object.entries(results).map(([score,cnt])=>({score,prob:cnt/n}));
  arr.sort((a,b)=>b.prob-a.prob);
  return arr.slice(0,6);
}

function analisis(){
  let teamHome = document.getElementById('team_home').value;
  let teamAway = document.getElementById('team_away').value;

  let gfHome = parseFloat(document.getElementById('gf_home').value)||0;
  let gaHome = parseFloat(document.getElementById('ga_home').value)||0;
  let gfAway = parseFloat(document.getElementById('gf_away').value)||0;
  let gaAway = parseFloat(document.getElementById('ga_away').value)||0;

  let h2hHome = parseFloat(document.getElementById('h2h_home').value)||0;
  let h2hAway = parseFloat(document.getElementById('h2h_away').value)||0;
  let formHome = parseFloat(document.getElementById('form_home').value)||0;
  let formAway = parseFloat(document.getElementById('form_away').value)||0;

  let lineOU = parseFloat(document.getElementById('line_ou').value)||2.5;
  let oddsOver = parseFloat(document.getElementById('odds_over').value)||0;
  let oddsUnder = parseFloat(document.getElementById('odds_under').value)||0;

  let squadDepthHome, squadDepthAway;
  if (squadMode.value === 'auto') {
    squadDepthHome = autoSquadDepth(gfHome, gaHome);
    squadDepthAway = autoSquadDepth(gfAway, gaAway);
  } else {
    squadDepthHome = parseFloat(document.getElementById('squad_home_manual').value)||1.0;
    squadDepthAway = parseFloat(document.getElementById('squad_away_manual').value)||1.0;
  }

  let expHome = (gfHome+ (h2hHome||gfHome) + (formHome||gfHome))/3;
  let expAway = (gfAway+ (h2hAway||gfAway) + (formAway||gfAway))/3;

  let adj = applyInjuryV4(expHome, expAway);
  expHome = adj.expHome; expAway = adj.expAway;

  let total = expHome+expAway;
  let pOver = total / (lineOU+0.5);
  pOver = Math.max(0, Math.min(1, pOver));
  let pUnder = 1 - pOver;
  let pBTTS = Math.min(1, (expHome/2 + expAway/2)/1.5);

  let hdpLine = (expHome - expAway).toFixed(2);
  let fav = expHome>expAway ? teamHome : teamAway;

  let impliedOver = oddsOver>0 ? 1/oddsOver : 0;
  let impliedUnder = oddsUnder>0 ? 1/oddsUnder : 0;
  let sumImp = impliedOver+impliedUnder;
  if(sumImp>0){ impliedOver/=sumImp; impliedUnder/=sumImp; }

  function confidence(prob, implied){
    return Math.abs(prob - implied) * 100;
  }

  let rekOU = "‚ùå No Bet";
  let confOU = 0;
  if(pOver - impliedOver > 0.08){ rekOU = "üî• Over "+lineOU; confOU = confidence(pOver, impliedOver); }
  else if(pUnder - impliedUnder > 0.08){ rekOU = "üî• Under "+lineOU; confOU = confidence(pUnder, impliedUnder); }

  let rekBTTS = "‚ùå No Bet", confBTTS=0;
  if(pBTTS>0.55){ rekBTTS = "üî• BTTS: YES"; confBTTS = (pBTTS-0.5)*200; }
  else if(pBTTS<0.45){ rekBTTS = "üî• BTTS: NO"; confBTTS = (0.5-pBTTS)*200; }

  let rekHDP = "‚ùå Hindari HDP (imbang)", confHDP=0;
  if(Math.abs(expHome-expAway)>=0.25){
    rekHDP = `üî• HDP: ${fav} -${Math.abs(hdpLine)}`;
    confHDP = Math.abs(expHome-expAway)*50;
  }

  let trapMsg = "";
  if (pOver > impliedOver && rekOU.includes("Under")) {
    trapMsg = "<div class='trap'>‚ö†Ô∏èüîí Potensi Trap: Market condong ke Over, model rekomendasi Under ‚Üí Hindari bet besar!</div>";
  }
  if (pUnder > impliedUnder && rekOU.includes("Over")) {
    trapMsg = "<div class='trap'>‚ö†Ô∏èüîí Potensi Trap: Market condong ke Under, model rekomendasi Over ‚Üí Hindari bet besar!</div>";
  }

  let warningMsg = "";
  if(confOU<25 && confBTTS<25 && confHDP<25){
    warningMsg = '<div class="warning">‚ö†Ô∏è Semua rekomendasi confidence rendah ‚Üí Hindari pertandingan ini!</div>';
  }

  let sims = simulateScores(expHome, expAway, 5000);
  let simTable = '<table class="sim-table"><tr><th>Skor</th><th>Probabilitas</th></tr>' +
    sims.map(s=>`<tr><td>${s.score}</td><td>${(s.prob*100).toFixed(1)}%</td></tr>`).join('') + '</table>';

  document.getElementById('output').innerHTML = `
    <h3>${teamHome} vs ${teamAway}</h3>
    <p>‚öΩ ExpGoals ‚Üí Home: ${expHome.toFixed(2)} | Away: ${expAway.toFixed(2)}</p>
    <p>üìä Rekomendasi O/U: ${rekOU} (<span class='${getConfidenceClass(confOU)}'>Conf: ${confOU.toFixed(1)}%</span>)</p>
    <p>ü§ù Rekomendasi BTTS: ${rekBTTS} (<span class='${getConfidenceClass(confBTTS)}'>Conf: ${confBTTS.toFixed(1)}%</span>)</p>
    <p>üéØ Rekomendasi HDP: ${rekHDP} (<span class='${getConfidenceClass(confHDP)}'>Conf: ${confHDP.toFixed(1)}%</span>)</p>
    ${trapMsg}
    ${warningMsg}
    <h4>üîÆ Simulasi Skor (Top 6)</h4>
    ${simTable}
  `;
}
</script>
</body>
</html>
