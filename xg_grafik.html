<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prediksi OU & Handicap + Confidence</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; padding: 20px; }
    h2 { color: #222; }
    input, select, button { margin: 5px; padding: 5px; }
    .result { display: flex; justify-content: space-between; margin-top: 20px; }
    .box { width: 48%; background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
    pre { background: #222; color: #0f0; padding: 8px; border-radius: 4px; overflow-x: auto; }
    .summary { margin-top: 15px; padding: 10px; background: #fff; border: 1px solid #ccc; border-radius: 6px; }
    .final { margin-top: 20px; padding: 15px; background: #dff0d8; border: 1px solid #3c763d; border-radius: 6px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Prediksi Over/Under & Handicap + Confidence</h2>
  
  URL Tim 1: 
  <input type="text" id="url1" size="60" value="https://understat.com/team/Arsenal/2025"><br>
  URL Tim 2: 
  <input type="text" id="url2" size="60" value="https://understat.com/team/Chelsea/2025"><br>
  
  Pilih Jumlah Match: 
  <select id="jumlah">
    <option value="5">5</option>
    <option value="10" selected>10</option>
    <option value="15">15</option>
  </select>
  
  <button onclick="bandingkan()">Bandingkan</button>
  
  <div class="result">
    <div class="box"><h3>Tim 1</h3><div id="hasil1">Loading...</div></div>
    <div class="box"><h3>Tim 2</h3><div id="hasil2">Loading...</div></div>
  </div>
  
  <canvas id="chartOU" style="margin-top:30px;"></canvas>
  <canvas id="chartHDP" style="margin-top:30px;"></canvas>

  <div id="summaryOU" class="summary"></div>
  <div id="summaryHDP" class="summary"></div>
  <div id="finalPrediksi" class="final"></div>
  
  <script>
    function rekomendasiOU(totalXG) {
      if (totalXG >= 3.0) return "Over";
      if (totalXG <= 2.3) return "Under";
      return "Abu-abu";
    }
    function rekomendasiHDP(xgHome, xgAway) {
      let selisih = xgHome - xgAway;
      if (selisih >= 0.8) return "Home";
      if (selisih <= -0.8) return "Away";
      return "Imbang";
    }

    async function ambilData(url, jumlah, idDiv) {
      try {
        let proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(url);
        let res = await fetch(proxyUrl);
        let proxyData = await res.json();
        let text = proxyData.contents;

        let jsonString = text.match(/<script id="__NEXT_DATA__" type="application\/json">(.*?)<\/script>/)[1];
        let data = JSON.parse(jsonString);
        let matches = data.props.pageProps.data.history;
        let teamName = data.props.pageProps.data.id.title;

        let lastMatches = matches.slice(-jumlah);
        let output = `<pre>`;
        
        let countOU = {Over:0, Under:0, "Abu-abu":0};
        let countHDP = {Home:0, Away:0, Imbang:0};
        let totalXG = 0;

        lastMatches.forEach(m => {
          let xgHome = parseFloat(m.xG.h);
          let xgAway = parseFloat(m.xG.a);
          let total = xgHome + xgAway;
          totalXG += total;

          let ou = rekomendasiOU(total);
          let hdp = rekomendasiHDP(xgHome, xgAway);

          countOU[ou]++; 
          countHDP[hdp]++;

          output += `${m.h.title} vs ${m.a.title}\n`;
          output += `xG: ${xgHome.toFixed(2)} - ${xgAway.toFixed(2)} (Total: ${total.toFixed(2)})\n`;
          output += `‚û°Ô∏è OU: ${ou} | HDP: ${hdp}\n\n`;
        });

        output += `</pre>`;
        document.getElementById(idDiv).innerHTML = `<b>${teamName}</b><br>` + output;

        let avgXG = totalXG / lastMatches.length;

        return {teamName, countOU, countHDP, jumlah, avgXG};
      } catch (err) {
        document.getElementById(idDiv).innerHTML = "‚ùå Error: " + err;
        return null;
      }
    }

    function buatPersentase(count, total) {
      let result = {};
      for (let key in count) {
        result[key] = ((count[key] / total) * 100).toFixed(1) + "%";
      }
      return result;
    }

    function hitungConfidenceOU(data1, data2) {
      let over = data1.countOU.Over + data2.countOU.Over;
      let under = data1.countOU.Under + data2.countOU.Under;
      let total = over + under;

      if (total === 0) return "50%";

      let persen = Math.max(over, under) / total * 100;
      return persen.toFixed(1) + "%";
    }

    function hitungConfidenceHDP(data1, data2) {
      let selisih = Math.abs(data1.avgXG - data2.avgXG);
      let persen = Math.min(95, (selisih / 1.5) * 100); // max 95% biar realistis
      return persen.toFixed(1) + "%";
    }

    function prediksiGabungan(data1, data2) {
      let prediksiOU = (data1.avgXG + data2.avgXG) / 2 >= 2.7 ? "OVER" : "UNDER";
      let confOU = hitungConfidenceOU(data1, data2);

      let prediksiHDP = data1.avgXG > data2.avgXG ? data1.teamName : data2.teamName;
      let confHDP = hitungConfidenceHDP(data1, data2);

      return `Prediksi Gabungan: 
      üîπ Over/Under ‚Üí ${prediksiOU} (Confidence: ${confOU})
      üîπ Handicap ‚Üí Lebih unggul: ${prediksiHDP} (Confidence: ${confHDP})`;
    }

    async function bandingkan() {
      let url1 = document.getElementById("url1").value;
      let url2 = document.getElementById("url2").value;
      let jumlah = parseInt(document.getElementById("jumlah").value);

      let data1 = await ambilData(url1, jumlah, "hasil1");
      let data2 = await ambilData(url2, jumlah, "hasil2");

      if (!data1 || !data2) return;

      let ou1 = buatPersentase(data1.countOU, data1.jumlah);
      let ou2 = buatPersentase(data2.countOU, data2.jumlah);
      let hdp1 = buatPersentase(data1.countHDP, data1.jumlah);
      let hdp2 = buatPersentase(data2.countHDP, data2.jumlah);

      document.getElementById("summaryOU").innerHTML = `
        <h3>Persentase Over/Under</h3>
        <b>${data1.teamName}</b> ‚Üí Over: ${ou1.Over}, Under: ${ou1.Under}, Abu-abu: ${ou1["Abu-abu"]}<br>
        <b>${data2.teamName}</b> ‚Üí Over: ${ou2.Over}, Under: ${ou2.Under}, Abu-abu: ${ou2["Abu-abu"]}
      `;

      document.getElementById("summaryHDP").innerHTML = `
        <h3>Persentase Handicap</h3>
        <b>${data1.teamName}</b> ‚Üí Home: ${hdp1.Home}, Away: ${hdp1.Away}, Imbang: ${hdp1.Imbang}<br>
        <b>${data2.teamName}</b> ‚Üí Home: ${hdp2.Home}, Away: ${hdp2.Away}, Imbang: ${hdp2.Imbang}
      `;

      document.getElementById("finalPrediksi").innerText = prediksiGabungan(data1, data2);

      new Chart(document.getElementById("chartOU"), {
        type: "bar",
        data: {
          labels: ["Over", "Under", "Abu-abu"],
          datasets: [
            {label: data1.teamName, data: [data1.countOU.Over, data1.countOU.Under, data1.countOU["Abu-abu"]], backgroundColor: "rgba(255,99,132,0.6)"},
            {label: data2.teamName, data: [data2.countOU.Over, data2.countOU.Under, data2.countOU["Abu-abu"]], backgroundColor: "rgba(54,162,235,0.6)"}
          ]
        },
        options: { responsive: true, plugins: { title: { display: true, text: "Perbandingan Over/Under" } } }
      });

      new Chart(document.getElementById("chartHDP"), {
        type: "bar",
        data: {
          labels: ["Home", "Away", "Imbang"],
          datasets: [
            {label: data1.teamName, data: [data1.countHDP.Home, data1.countHDP.Away, data1.countHDP.Imbang], backgroundColor: "rgba(255,206,86,0.6)"},
            {label: data2.teamName, data: [data2.countHDP.Home, data2.countHDP.Away, data2.countHDP.Imbang], backgroundColor: "rgba(75,192,192,0.6)"}
          ]
        },
        options: { responsive: true, plugins: { title: { display: true, text: "Perbandingan Handicap" } } }
      });
    }
  </script>
</body>
</html>