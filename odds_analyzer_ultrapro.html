!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Odds Analyzer — Ultra-Pro+</title>
  <style>
    body{font-family:Inter, Arial, sans-serif; background:#f4f6f8; color:#111; margin:20px;}
    .wrap{max-width:1100px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 24px rgba(12,30,60,0.08);}
    h1{margin:0 0 14px;font-size:20px;}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
    label{font-size:13px;color:#333;margin-top:8px;display:block;}
    input[type="number"], input[type="text"], select, textarea{width:100%;padding:8px;border:1px solid #d7dce3;border-radius:6px;font-size:14px;}
    textarea{height:60px;resize:vertical;}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0b69ff;color:#fff;font-weight:600;cursor:pointer;}
    button.secondary{background:#6c757d;margin-left:8px;}
    #result{margin-top:18px;padding:14px;background:#fcfdff;border:1px solid #e6eefc;border-radius:8px;white-space:pre-wrap;}
    .row{display:flex;gap:12px;}
    .col{flex:1;}
    .muted{color:#666;font-size:13px;}
    .small{font-size:13px;}
    .danger{color:#b00020}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>⚽ Odds Analyzer — Ultra-Pro+</h1>
    <div class="grid">
      <div>
        <label>Kompetisi / Liga</label>
        <select id="leagueSelect">
          <option value="">-- pilih liga --</option>
          <option>Premier League</option>
          <option>Championship</option>
          <option>FA Cup</option>
          <option>EFL Cup (Carabao Cup)</option>
          <option>La Liga</option>
          <option>Segunda División</option>
          <option>Copa del Rey</option>
          <option>Serie A</option>
          <option>Serie B</option>
          <option>Coppa Italia</option>
          <option>Bundesliga</option>
          <option>2. Bundesliga</option>
          <option>DFB-Pokal</option>
          <option>Ligue 1</option>
          <option>Ligue 2</option>
          <option>Coupe de France</option>
          <option>Eredivisie</option>
          <option>Eerste Divisie</option>
          <option>KNVB Cup</option>
          <option>Primeira Liga</option>
          <option>Taça de Portugal</option>
          <option>Swiss Super League</option>
          <option>Swiss Cup</option>
          <option>Süper Lig</option>
          <option>Turkish Cup</option>
          <option>Super League Greece</option>
          <option>Greek Cup</option>
          <option>Russian Premier League</option>
          <option>Russian Cup</option>
          <option>Liga I</option>
          <option>Cupa României</option>
          <option>Ekstraklasa</option>
          <option>Polish Cup</option>
          <option>HNL</option>
          <option>Croatian Cup</option>
          <option>Latvia Higher League</option>
          <option>Latvian Cup</option>
          <option>Meistriliiga</option>
          <option>Estonian Cup</option>
          <option>Allsvenskan</option>
          <option>Svenska Cupen</option>
          <option>Eliteserien</option>
          <option>Norwegian Cup</option>
          <option>Superliga</option>
          <option>1st Division</option>
          <option>Danish Cup</option>
          <option>Veikkausliiga</option>
          <option>Ykkösliiga</option>
          <option>Ykkönen</option>
          <option>Suomen Cup</option>
          <option>Úrvalsdeild</option>
          <option>Icelandic Cup</option>
          <option>Premier Division</option>
          <option>FAI Cup</option>
          <option>UEFA Champions League</option>
          <option>UEFA Europa League</option>
          <option>UEFA Conference League</option>
          <option>World Cup</option>
        </select>
            </div>
              <label>Rata-Rata Gol Liga (auto)</label>
        <input id="leagueAvg" type="text" readonly />
      </div>

      <div>
        <label>Value Bet Threshold (%)</label>
        <input id="valueThreshPercent" type="number" value="8" step="0.1" />
      </div>
    </div>

    <h3 style="margin-top:12px">Data tim (season / optional recent & H2H)</h3>
    <div class="grid">
      <div>
        <label>Home GF (season avg)</label>
        <input id="homeGF" type="number" value="1.4" step="0.01" />
        <label class="small muted">Home recent (comma, last up to 5 matches) — optional</label>
        <textarea id="homeRecent" placeholder="contoh: 1,2,0,1,3"></textarea>
      </div>

      <div>
        <label>Home GA (season avg)</label>
        <input id="homeGA" type="number" value="1.3" step="0.01" />
        <label class="small muted">Home H2H goals vs opponent (comma) — optional</label>
        <textarea id="homeH2H" placeholder="contoh: 1,0,2"></textarea>
      </div>

      <div>
        <label>Away GF (season avg)</label>
        <input id="awayGF" type="number" value="1.3" step="0.01" />
        <label class="small muted">Away recent (comma) — optional</label>
        <textarea id="awayRecent" placeholder="contoh: 2,1,1,0,2"></textarea>
      </div>
    </div>

    <div class="grid" style="margin-top:8px">
      <div>
        <label>Away GA (season avg)</label>
        <input id="awayGA" type="number" value="1.4" step="0.01" />
        <label class="small muted">Away H2H goals (comma) — optional</label>
        <textarea id="awayH2H" placeholder="contoh: 0,1,1"></textarea>
  </div>
  <div>
        <label>Dispersion (league) — optional</label>
        <input id="dispersion" type="number" value="" step="0.01" placeholder="kosong = pakai default liga" />
      </div>

      <div>
        <label>Match Type Factor (cup / CL) — optional</label>
        <input id="matchTypeFactor" type="number" value="" step="0.01" placeholder="kosong = pakai default liga" />
      </div>
    </div>

    <h3 style="margin-top:12px">Market Odds</h3>
    <div class="grid">
      <div>
        <label>Odds Over 2.5 (decimal)</label>
        <input id="oddsOver" type="number" value="1.90" step="0.01" />
        <label style="margin-top:6px">Odds HDP Home (generic)</label>
        <input id="oddsHdpHome" type="number" value="1.95" step="0.01" />
      </div>

      <div>
        <label>Odds Under 2.5 (decimal)</label>
        <input id="oddsUnder" type="number" value="1.95" step="0.01" />
        <label style="margin-top:6px">Odds HDP Away (generic)</label>
        <input id="oddsHdpAway" type="number" value="1.95" step="0.01" />
      </div>

      <div>
        <label>Odds Home (1X2)</label>
        <input id="oddsHome" type="number" value="2.10" step="0.01" />
        <label style="margin-top:6px">Odds Draw</label>
        <input id="oddsDraw" type="number" value="3.20" step="0.01" />
        <label style="margin-top:6px">Odds Away</label>
        <input id="oddsAway" type="number" value="3.40" step="0.01" />
      </div>
          </div>
          <div style="margin-top:12px" class="row">
      <div class="col">
        <label>HDP Line (contoh -0.5, -0.25, 0, 0.25)</label>
        <input id="hdpLine" type="number" value="-0.5" step="0.25" />
      </div>
      <div class="col" style="display:flex;align-items:flex-end;">
        <button id="btnAnalyze">🔎 Analisis Sekarang</button>
        <button id="btnReset" class="secondary">Reset</button>
      </div>
    </div>

    <div id="result"></div>
    <p class="muted small" style="margin-top:10px">
      Tip: isi recent/H2H dengan format angka terpisah koma (contoh "1,2,0,1,3"). Jika tidak ada, model fallback ke season averages. Dispersion / matchType bisa dikosongkan untuk pakai default liga.
    </p>
  </div>

<script>
/* ===== League meta (avg, baseK, homeBias, reliability, dispersion, matchTypeFactor) ===== */
const leagueMeta = {
  "Premier League": {avg:2.65, baseK:1.2, homeBias:0.08, reliability:0.9, dispersion:0.12},
  "Championship": {avg:2.45, baseK:1.18, homeBias:0.07, reliability:0.87, dispersion:0.11},
  "FA Cup": {avg:3.20, baseK:1.25, homeBias:0.05, reliability:0.75, dispersion:0.14},
  "EFL Cup (Carabao Cup)": {avg:3.10, baseK:1.24, homeBias:0.05, reliability:0.74, dispersion:0.14},
  "La Liga": {avg:2.62, baseK:1.18, homeBias:0.07, reliability:0.9, dispersion:0.11},
  "Segunda División": {avg:2.55, baseK:1.17, homeBias:0.07, reliability:0.85, dispersion:0.11},
  "Copa del Rey": {avg:2.95, baseK:1.22, homeBias:0.06, reliability:0.78, dispersion:0.12},
  "Serie A": {avg:2.56, baseK:1.18, homeBias:0.07, reliability:0.88, dispersion:0.12},
  "Serie B": {avg:2.47, baseK:1.17, homeBias:0.07, reliability:0.85, dispersion:0.11},
  "Coppa Italia": {avg:3.00, baseK:1.24, homeBias:0.05, reliability:0.75, dispersion:0.13},
  "Bundesliga": {avg:3.14, baseK:1.25, homeBias:0.09, reliability:0.9, dispersion:0.15},
  "2. Bundesliga": {avg:3.02, baseK:1.22, homeBias:0.08, reliability:0.88, dispersion:0.14},
  "DFB-Pokal": {avg:4.19, baseK:1.28, homeBias:0.05, reliability:0.7, dispersion:0.18},
  "Ligue 1": {avg:2.96, baseK:1.2, homeBias:0.07, reliability:0.9, dispersion:0.12},
  "Ligue 2": {avg:2.41, baseK:1.16, homeBias:0.06, reliability:0.85, dispersion:0.11},
  "Coupe de France": {avg:3.20, baseK:1.25, homeBias:0.05, reliability:0.72, dispersion:0.14},
  "Eredivisie": {avg:2.98, baseK:1.22, homeBias:0.08, reliability:0.88, dispersion:0.14},
  "Eerste Divisie": {avg:3.10, baseK:1.23, homeBias:0.07, reliability:0.84, dispersion:0.15},
  "KNVB Cup": {avg:3.80, baseK:1.30, homeBias:0.05, reliability:0.7, dispersion:0.18},
  "Primeira Liga": {avg:2.87, baseK:1.18, homeBias:0.07, reliability:0.9, dispersion:0.12},
  "Taça de Portugal": {avg:2.90, baseK:1.22, homeBias:0.05, reliability:0.75, dispersion:0.13},
  "Swiss Super League": {avg:3.33, baseK:1.24, homeBias:0.08, reliability:0.88, dispersion:0.15},
  "Swiss Cup": {avg:3.50, baseK:1.26, homeBias:0.05, reliability:0.72, dispersion:0.16},
  "Süper Lig": {avg:2.94, baseK:1.2, homeBias:0.08, reliability:0.88, dispersion:0.12},
  "Turkish Cup": {avg:2.90, baseK:1.22, homeBias:0.05, reliability:0.75, dispersion:0.13},
  "Super League Greece": {avg:2.97, baseK:1.18, homeBias:0.07, reliability:0.85, dispersion:0.11},
  "Greek Cup": {avg:2.30, baseK:1.15, homeBias:0.05, reliability:0.7, dispersion:0.10},
  "Russian Premier League": {avg:2.70, baseK:1.17, homeBias:0.08, reliability:0.85, dispersion:0.12},
  "Russian Cup": {avg:2.80, baseK:1.20, homeBias:0.05, reliability:0.75, dispersion:0.12},
  "Liga I": {avg:2.67, baseK:1.16, homeBias:0.07, reliability:0.85, dispersion:0.11},
  "Cupa României": {avg:3.20, baseK:1.25, homeBias:0.05, reliability:0.75, dispersion:0.14},
  "Ekstraklasa": {avg:2.85, baseK:1.17, homeBias:0.07, reliability:0.87, dispersion:0.12},
  "Polish Cup": {avg:2.90, baseK:1.22, homeBias:0.05, reliability:0.75, dispersion:0.12},
  "HNL": {avg:2.36, baseK:1.15, homeBias:0.07, reliability:0.85, dispersion:0.10},
  "Croatian Cup": {avg:3.10, baseK:1.24, homeBias:0.05, reliability:0.7, dispersion:0.14},
  "Latvia Higher League": {avg:2.89, baseK:1.16, homeBias:0.07, reliability:0.85, dispersion:0.12},
  "Latvian Cup": {avg:4.90, baseK:1.3, homeBias:0.05, reliability:0.72, dispersion:0.18},
  "Meistriliiga": {avg:3.22, baseK:1.20, homeBias:0.07, reliability:0.84, dispersion:0.14},
  "Estonian Cup": {avg:4.50, baseK:1.30, homeBias:0.05, reliability:0.72, dispersion:0.17},
  "Allsvenskan": {avg:2.83, baseK:1.18, homeBias:0.07, reliability:0.86, dispersion:0.12},
  "Svenska Cupen": {avg:3.10, baseK:1.24, homeBias:0.05, reliability:0.75, dispersion:0.14},
  "Eliteserien": {avg:2.83, baseK:1.19, homeBias:0.07, reliability:0.86, dispersion:0.12},
  "Norwegian Cup": {avg:3.60, baseK:1.25, homeBias:0.05, reliability:0.75, dispersion:0.15},
  "Superliga": {avg:3.27, baseK:1.20, homeBias:0.08, reliability:0.85, dispersion:0.14},
  "1st Division": {avg:2.81, baseK:1.17, homeBias:0.07, reliability:0.85, dispersion:0.12},
  "Danish Cup": {avg:4.00, baseK:1.28, homeBias:0.05, reliability:0.72, dispersion:0.16},
  "Veikkausliiga": {avg:2.93, baseK:1.18, homeBias:0.07, reliability:0.85, dispersion:0.12},
  "Ykkösliiga": {avg:3.02, baseK:1.23, homeBias:0.07, reliability:0.84, dispersion:0.13},
  "Ykkönen": {avg:3.51, baseK:1.23, homeBias:0.07, reliability:0.82, dispersion:0.14},
  "Suomen Cup": {avg:4.00, baseK:1.28, homeBias:0.05, reliability:0.72, dispersion:0.16},
  "Úrvalsdeild": {avg:3.62, baseK:1.25, homeBias:0.08, reliability:0.84, dispersion:0.16},
  "Icelandic Cup": {avg:5.00, baseK:1.30, homeBias:0.05, reliability:0.7, dispersion:0.18},
  "Premier Division": {avg:2.26, baseK:1.14, homeBias:0.06, reliability:0.85, dispersion:0.10},
  "FAI Cup": {avg:3.00, baseK:1.24, homeBias:0.05, reliability:0.75, dispersion:0.13},
  "UEFA Champions League": {avg:3.10, baseK:1.22, homeBias:0.08, reliability:0.9, dispersion:0.13, matchTypeFactor:1.08},
  "UEFA Europa League": {avg:2.85, baseK:1.18, homeBias:0.07, reliability:0.88, dispersion:0.12, matchTypeFactor:1.05},
  "UEFA Conference League": {avg:2.71, baseK:1.17, homeBias:0.07, reliability:0.87, dispersion:0.12, matchTypeFactor:1.03},
  "World Cup": {avg:2.70, baseK:1.15, homeBias:0.06, reliability:0.92, dispersion:0.11, matchTypeFactor:0.95}
};
  /* ===== helpers ===== */
function parseCsvNums(s){
  if(!s) return [];
  return s.split(",").map(x=>parseFloat(x.trim())).filter(x=>!isNaN(x));
}
function avg(arr){ if(!arr || arr.length===0) return 0; return arr.reduce((a,b)=>a+b,0)/arr.length; }
function factorial(n){ if(n<=1) return 1; let r=1; for(let i=2;i<=n;i++) r*=i; return r; }
function poissonPMF(lambda,k){ if(lambda<=0) return k===0?1:0; return Math.pow(lambda,k)*Math.exp(-lambda)/factorial(k); }
function negBinomialPMF(mu,k,disp){ if(!disp || disp<=0) return poissonPMF(mu,k); const r = 1/disp; const p = r/(r+mu); let coeff=1; for(let i=0;i<k;i++) coeff *= (r + i)/(i+1); return coeff*Math.pow(1-p,r)*Math.pow(p,k); }
function normalize(arr){ const s = arr.reduce((a,b)=>a+b,0) || 1; return arr.map(x=>x/s); }
function impliedProb(odds){ return odds>0? 1/odds : 0; }

/* compute handicap probs from matrix */
function computeHandicapProbsFromMatrix(matrix, maxGoals){
  const diffProb = {};
  for(let i=0;i<=maxGoals;i++){
    for(let j=0;j<=maxGoals;j++){
      const p = (matrix[i] && matrix[i][j])? matrix[i][j] : 0;
      const d = i-j;
      diffProb[d] = (diffProb[d] || 0) + p;
    }
  }
  const diffs = Object.keys(diffProb).map(k=>parseInt(k)).sort((a,b)=>a-b);
  function P_gt(x){ let s=0; for(const k of diffs) if(k > x) s += diffProb[k]; return s; }
  function P_eq(x){ return diffProb[x] || 0; }
  function P_lt(x){ let s=0; for(const k of diffs) if(k < x) s += diffProb[k]; return s; }

  function probsForHandicap(h){
    const q = Math.round(h*4);
    if(q % 2 === 0){
      if(q % 4 === 0){
        const inum = q/4;
        const thr = -inum;
        return {home:P_gt(thr), draw:P_eq(thr), away:P_lt(thr)};
      } else {
        const thr = -q/4;
        return {home:P_gt(thr), draw:0, away:P_lt(thr) + P_eq(thr)};
      }
    } else {
      const hi = Math.ceil(q/2)/2;
      const lo = Math.floor(q/2)/2;
      const pah = probsForHandicap(hi);
      const pal = probsForHandicap(lo);
      return {home:0.5*(pah.home+pal.home), draw:0.5*(pah.draw+pal.draw), away:0.5*(pah.away+pal.away)};
    }
  }

  let totalHome=0,totalDraw=0,totalAway=0;
  for(const k of diffs){
    if(k>0) totalHome += diffProb[k];
    else if(k===0) totalDraw += diffProb[k];
    else totalAway += diffProb[k];
  }

  return {diffProb, probsForHandicap, totals:{home:totalHome, draw:totalDraw, away:totalAway}};
}

/* ===== main ultra-pro analyze ===== */
function analyze(){
  // read UI
  const leagueName = document.getElementById("leagueSelect").value;
  const meta = leagueMeta[leagueName] || {avg:2.6, baseK:1.15, homeBias:0.07, reliability:0.85, dispersion:0.12};
  // show league avg
  document.getElementById("leagueAvg").value = meta.avg ? meta.avg.toFixed(2) : "";

  const homeGF = parseFloat(document.getElementById("homeGF").value) || 0;
  const homeGA = parseFloat(document.getElementById("homeGA").value) || 0;
  const awayGF = parseFloat(document.getElementById("awayGF").value) || 0;
  const awayGA = parseFloat(document.getElementById("awayGA").value) || 0;

  // optional arrays
  const homeRecent = parseCsvNums(document.getElementById("homeRecent").value);
  const awayRecent = parseCsvNums(document.getElementById("awayRecent").value);
  const homeH2H = parseCsvNums(document.getElementById("homeH2H").value);
  const awayH2H = parseCsvNums(document.getElementById("awayH2H").value);

  const homeRecentAvg = homeRecent.length ? avg(homeRecent) : homeGF;
  const awayRecentAvg = awayRecent.length ? avg(awayRecent) : awayGF;
  const homeH2HAvg = homeH2H.length ? avg(homeH2H) : homeGF;
  const awayH2HAvg = awayH2H.length ? avg(awayH2H) : awayGF;

  // optional override dispersion / matchTypeFactor
  const dispInput = parseFloat(document.getElementById("dispersion").value);
  const matchTypeInput = parseFloat(document.getElementById("matchTypeFactor").value);
  const dispersion = !isNaN(dispInput) ? dispInput : (meta.dispersion || 0.12);
  const matchTypeFactor = !isNaN(matchTypeInput) ? matchTypeInput : (meta.matchTypeFactor || 1.0);

  let valueThresh = (parseFloat(document.getElementById("valueThreshPercent").value) || 8)/100;
  if(meta.avg >= 3.2) valueThresh = Math.min(valueThresh, 0.06);
  if(meta.avg <= 2.3) valueThresh = Math.max(valueThresh, 0.10);

  // momentum adjustments
  let homeGF_adj = homeGF;
  let awayGF_adj = awayGF;
  if(homeRecentAvg > homeGF * 1.25) homeGF_adj *= 1.08;
  if(awayRecentAvg > awayGF * 1.25) awayGF_adj *= 1.08;

  // combined GF weights: 50% recent, 25% H2H, 25% season
  const homeGF_combined = 0.5*homeRecentAvg + 0.25*homeH2HAvg + 0.25*homeGF_adj;
  const awayGF_combined = 0.5*awayRecentAvg + 0.25*awayH2HAvg + 0.25*awayGF_adj;

  // league factor scaling
  let goalFactor = 1.0;
  if(meta.avg >= 3.2) goalFactor = 1.18;
  else if(meta.avg >= 3.0) goalFactor = 1.12;
  else if(meta.avg <= 2.3) goalFactor = 0.90;

  const homeBias = meta.homeBias || 0.07;
  const baseK = meta.baseK || 1.15;
  const reliability = meta.reliability || 0.85;

  // lambdas
  let lambdaHome = (homeGF_combined * awayGA / (meta.avg || 2.6)) * (1 + homeBias) * baseK * goalFactor * matchTypeFactor * reliability;
  let lambdaAway = (awayGF_combined * homeGA / (meta.avg || 2.6)) * baseK * goalFactor * matchTypeFactor * reliability;

  // dispersion multiplier
  lambdaHome *= (1 + dispersion);
  lambdaAway *= (1 + dispersion);

  lambdaHome = Math.max(lambdaHome, 0.02);
  lambdaAway = Math.max(lambdaAway, 0.02);

  // build 3-layer hybrid distributions up to maxGoals
  const maxGoals = 25;
  const decay = 0.955;
  let pHome = new Array(maxGoals+1).fill(0);
  let pAway = new Array(maxGoals+1).fill(0);

  // Poisson (50%)
  for(let g=0; g<=maxGoals; g++){
    pHome[g] += 0.50 * poissonPMF(lambdaHome, g);
    pAway[g] += 0.50 * poissonPMF(lambdaAway, g);
  }
  // NegBin (30%)
  for(let g=0; g<=maxGoals; g++){
    pHome[g] += 0.30 * negBinomialPMF(lambdaHome, g, dispersion);
    pAway[g] += 0.30 * negBinomialPMF(lambdaAway, g, dispersion);
  }
  // Poisson long-tail smoothing (20%)
  for(let g=0; g<=maxGoals; g++){
    pHome[g] += 0.20 * poissonPMF(lambdaHome, g) * Math.pow(decay, Math.max(0, g-6));
    pAway[g] += 0.20 * poissonPMF(lambdaAway, g) * Math.pow(decay, Math.max(0, g-6));
  }

  pHome = normalize(pHome);
  pAway = normalize(pAway);

  // joint matrix
  let matrix = [];
  for(let i=0;i<=maxGoals;i++){
    matrix[i] = [];
    for(let j=0;j<=maxGoals;j++){
      matrix[i][j] = (pHome[i]||0) * (pAway[j]||0);
    }
  }
  // compute totals & OU
  let probHome=0, probDraw=0, probAway=0, over25=0, under25=0, expectedTotalGoals=0;
  for(let i=0;i<=maxGoals;i++){
    for(let j=0;j<=maxGoals;j++){
      const p = matrix[i][j];
      if(i>j) probHome += p;
      else if(i===j) probDraw += p;
      else probAway += p;
      if(i + j >= 3) over25 += p;
      else under25 += p;
      expectedTotalGoals += (i+j) * p;
    }
  }

  // OU calibration
  if(meta.avg >= 3.2 && over25 < 0.50){
    over25 = Math.max(over25, 0.50);
    under25 = 1-over25;
  }
  if(meta.avg <= 2.3 && under25 < 0.50){
    under25 = Math.max(under25, 0.50);
    over25 = 1-under25;
  }

  // fair odds
  const fairHome = probHome > 0 ? 1/probHome : 0;
  const fairDraw = probDraw > 0 ? 1/probDraw : 0;
  const fairAway = probAway > 0 ? 1/probAway : 0;

  // market odds
  const oddsOver = parseFloat(document.getElementById("oddsOver").value) || 2.0;
  const oddsUnder = parseFloat(document.getElementById("oddsUnder").value) || 2.0;
  const oddsHome = parseFloat(document.getElementById("oddsHome").value) || 2.0;
  const oddsDraw = parseFloat(document.getElementById("oddsDraw").value) || 3.0;
  const oddsAway = parseFloat(document.getElementById("oddsAway").value) || 3.0;
  const oddsHdpHome = parseFloat(document.getElementById("oddsHdpHome").value) || 2.0;
  const oddsHdpAway = parseFloat(document.getElementById("oddsHdpAway").value) || 2.0;
  const hdpLineInput = parseFloat(document.getElementById("hdpLine").value) || -0.5;

  // EVs
  const evOver = over25 * oddsOver - 1;
  const evUnder = under25 * oddsUnder - 1;
  const evHome = probHome * oddsHome - 1;
  const evDraw = probDraw * oddsDraw - 1;
  const evAway = probAway * oddsAway - 1;

  // ATS HDP across many lines
  const atsObj = computeHandicapProbsFromMatrix(matrix, maxGoals);
  const lines = [];
  for(let q=-12; q<=12; q++) lines.push(q*0.25); // -3.0 .. +3.0 step 0.25
  const ats = {};
  lines.forEach(line=>{
    const p = atsObj.probsForHandicap(line);
    const evH = p.home * oddsHdpHome - (1 - p.home);
    const evA = p.away * oddsHdpAway - (1 - p.away);
    ats[line.toFixed(2)] = {homeProb:p.home, drawProb:p.draw, awayProb:p.away, evHome:evH, evAway:evA};
  });
  // choose best HDP by EV
  let bestHdp = {line:null, ev:-999, side:null, probs:null};
  Object.keys(ats).forEach(k=>{
    const a = ats[k];
    if(a.evHome > bestHdp.ev){ bestHdp = {line:k, ev:a.evHome, side:"home", probs:a}; }
    if(a.evAway > bestHdp.ev){ bestHdp = {line:k, ev:a.evAway, side:"away", probs:a}; }
  });

  // trap detection
  const traps = [];
  if(Math.abs(probHome - impliedProb(oddsHome)) > 0.07) traps.push("Home odds vs model mismatch (>7%)");
  if(Math.abs(probDraw - impliedProb(oddsDraw)) > 0.10) traps.push("Draw odds vs model mismatch (>10%)");
  if(Math.abs(probAway - impliedProb(oddsAway)) > 0.07) traps.push("Away odds vs model mismatch (>7%)");
  if(Math.abs(over25 - impliedProb(oddsOver)) > 0.12) traps.push("Over odds vs model mismatch (>12%)");
  if(Math.abs(under25 - impliedProb(oddsUnder)) > 0.12) traps.push("Under odds vs model mismatch (>12%)");
  if(oddsHome <= 1.60 && probHome < 0.55) traps.push("Market favors home strongly but model disagrees");
  if(oddsAway <= 1.60 && probAway < 0.55) traps.push("Market favors away strongly but model disagrees");
  if(bestHdp.ev < 0 && (impliedProb(oddsHome) - probHome) > 0.12) traps.push("HDP inconsistency with market");

  // effective threshold adjust if traps
  const trapPenalty = traps.length > 0 ? 0.03 : 0;
  const effectiveThresh = valueThresh + trapPenalty;

  // decide value bets
  const picks = [];
  if(evOver > effectiveThresh) picks.push({type:"Over 2.5", ev:evOver});
  if(evUnder > effectiveThresh) picks.push({type:"Under 2.5", ev:evUnder});
  if(evHome > effectiveThresh) picks.push({type:"Home Win", ev:evHome});
  if(evDraw > effectiveThresh) picks.push({type:"Draw", ev:evDraw});
  if(evAway > effectiveThresh) picks.push({type:"Away Win", ev:evAway});
  if(bestHdp.line !== null && bestHdp.ev > effectiveThresh) picks.push({type:`HDP ${bestHdp.side} ${bestHdp.line}`, ev: bestHdp.ev});

  // build html output
  let out = "";
  out += `<h3>Hasil Ultra-Pro — ${leagueName || "Custom"}</h3>`;
  out += `<p><b>λ (home / away):</b> ${lambdaHome.toFixed(2)} / ${lambdaAway.toFixed(2)}</p>`;
  out += `<p><b>1X2 Prob:</b> Home ${(probHome*100).toFixed(1)}% — Draw ${(probDraw*100).toFixed(1)}% — Away ${(probAway*100).toFixed(1)}%</p>`;
  out += `<p><b>Over 2.5:</b> ${(over25*100).toFixed(1)}% | <b>Under 2.5:</b> ${(under25*100).toFixed(1)}% | <b>Exp Goals:</b> ${expectedTotalGoals.toFixed(2)}</p>`;

  out += `<h4>Value Bet Candidates (threshold ${(effectiveThresh*100).toFixed(1)}%)</h4>`;
  if(picks.length === 0) out += `<p>❌ Tidak ada value bet signifikan.</p>`;
  else {
    out += `<ul>`;
    picks.sort((a,b)=>b.ev - a.ev).forEach(p => {
      out += `<li>${p.type} — EV ${(p.ev*100).toFixed(2)}%</li>`;
    });
    out += `</ul>`;
  }

  out += `<h4>HDP ATS Snapshot (pilihan terbaik)</h4>`;
  if(bestHdp.line !== null){
    out += `<p>Best HDP: ${bestHdp.side} ${bestHdp.line} — EV ${(bestHdp.ev*100).toFixed(2)}% — Probs Home ${(bestHdp.probs.home*100).toFixed(1)}% / Draw ${(bestHdp.probs.draw*100).toFixed(1)}% / Away ${(bestHdp.probs.away*100).toFixed(1)}%</p>`;
  } else {
    out += `<p>No HDP edge.</p>`;
  }

  out += `<h5>Contoh lines (home% / draw% / away% / EVH / EVA)</h5>`;
  const showLines = [-1.5,-1,-0.5,-0.25,0,0.25,0.5,1];
  showLines.forEach(l=>{
    const a = ats[l.toFixed(2)];
    if(a) out += `<div>${l}: Home ${(a.homeProb*100).toFixed(1)}% | Draw ${(a.drawProb*100).toFixed(1)}% | Away ${(a.awayProb*100).toFixed(1)}% — EVH ${(a.evHome*100).toFixed(1)}% EVA ${(a.evAway*100).toFixed(1)}%</div>`;
  });
  if(traps.length){
    out += `<h4 class="danger">Odds Trap Alerts</h4><ul>`;
    traps.forEach(t => out += `<li class="danger">${t}</li>`);
    out += `</ul>`;
  } else {
    out += `<p style="color:green"><b>No major traps detected.</b></p>`;
  }

  out += `<p style="font-size:12px;color:#444">Note: masukkan data recent/H2H (array goals) ke field terkait untuk hasil lebih akurat. Atau set window._homeRecent / window._awayRecent dari console sebelum tekan Analyze.</p>`;

  document.getElementById("result").innerHTML = out;
}

/* auto-update leagueAvg when user selects league */
document.getElementById("leagueSelect").addEventListener("change", function(){
  const meta = leagueMeta[this.value];
  document.getElementById("leagueAvg").value = meta ? (meta.avg ? meta.avg.toFixed(2) : "") : "";
});

/* buttons */
document.getElementById("btnAnalyze").addEventListener("click", analyze);
document.getElementById("btnReset").addEventListener("click", ()=>{
  // reset inputs (keep league list)
  document.querySelectorAll("input[type=number]").forEach(i=> {
    const id = i.id;
    if(id === "valueThreshPercent") i.value = 8;
    else if(id === "homeGF") i.value = 1.4;
    else if(id === "homeGA") i.value = 1.3;
    else if(id === "awayGF") i.value = 1.3;
    else if(id === "awayGA") i.value = 1.4;
    else if(id === "oddsOver") i.value = 1.90;
    else if(id === "oddsUnder") i.value = 1.95;
    else if(id === "oddsHome") i.value = 2.10;
    else if(id === "oddsDraw") i.value = 3.20;
    else if(id === "oddsAway") i.value = 3.40;
    else if(id === "oddsHdpHome") i.value = 1.95;
    else if(id === "oddsHdpAway") i.value = 1.95;
    else if(id === "hdpLine") i.value = -0.5;
    else if(id === "dispersion") i.value = "";
    else if(id === "matchTypeFactor") i.value = "";
  });
  document.querySelectorAll("textarea").forEach(t=> t.value = "");
  document.getElementById("result").innerHTML = "";
  document.getElementById("leagueSelect").value = "";
  document.getElementById("leagueAvg").value = "";
});
</script>
</body>
</html>
